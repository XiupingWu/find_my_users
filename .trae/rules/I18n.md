# FindMyUsers 国际化 (i18n) 开发规则

## 概述

FindMyUsers 项目使用 next-intl 库实现完整的国际化功能，支持中文（zh）和英文（en）两种语言。本文档定义了开发过程中必须遵循的i18n规则和最佳实践。

## 技术栈

- **next-intl**: 主要国际化库
- **Next.js App Router**: 路由国际化
- **路由策略**: 使用 `localePrefix: 'always'`，所有路径都带语言前缀

## 路由结构

### URL 结构
```
/zh/                    # 中文首页
/en/                    # 英文首页
/zh/site               # 中文分类页
/en/site               # 英文分类页
/zh/posts/[slug]       # 中文文章详情
/en/posts/[slug]       # 英文文章详情
/zh/site/[slug]        # 中文站点详情
/en/site/[slug]        # 英文站点详情
```

### 路由配置
- 默认语言：`zh` (中文)
- 支持语言：`['zh', 'en']`
- 路径前缀：始终显示语言前缀

## 数据文件结构

### 1. JSON 配置文件
```
data/
├── json/
│   ├── zh/            # 中文版本
│   │   ├── sitelists.json
│   │   └── articles.json    # 文章元数据（使用slug字段）
│   └── en/            # 英文版本
│       ├── sitelists.json
│       └── articles.json    # 包含fallback文章的元数据
```

#### articles.json 结构说明
- **用途**: 管理文章列表的元数据，控制文章在列表页面中的显示
- **字段**:
  - `title`: 文章标题
  - `description`: 文章描述
  - `date`: 发布日期
  - `lastModified`: 最后修改时间
  - `slug`: 文章标识符（用于URL路由）
  - `hasEnglish`: (仅英文版本)标记是否有英文版本

### 2. 文章文件
```
data/
├── Articles/
│   ├── zh/            # 中文文章
│   │   ├── article1.md
│   │   └── article2.md
│   └── en/            # 英文文章
│       ├── article1.md  # 如果存在英文版本
│       └── article3.md  # 只有英文版本的文章
```

### 3. 站点详情文件
```
data/
├── Site/
│   ├── zh/            # 中文站点详情
│   │   ├── nextjs.json
│   │   └── github.json
│   └── en/            # 英文站点详情
│       ├── nextjs.json
│       └── github.json
```

## Fallback 规则

### 重要原则
**如果指定语言的文件不存在，自动 fallback 到中文版本**

### 实现方式
使用 `src/lib/i18n-data.ts` 中的工具函数：
- `getI18nJsonData(filename, locale)` - 获取 JSON 数据
- `getI18nArticle(slug, locale)` - 获取文章数据
- `getI18nSiteData(slug, locale)` - 获取站点详情
- `getI18nArticlesList(locale)` - 获取文章列表（基于articles.json）

### Fallback 逻辑示例
```typescript
// 1. 尝试获取请求语言的文件
const localePath = path.join(process.cwd(), 'data', 'json', locale, filename);
if (fs.existsSync(localePath)) {
  return JSON.parse(fs.readFileSync(localePath, 'utf8'));
}

// 2. Fallback 到中文版本
const fallbackPath = path.join(process.cwd(), 'data', 'json', 'zh', filename);
if (fs.existsSync(fallbackPath)) {
  return JSON.parse(fs.readFileSync(fallbackPath, 'utf8'));
}
```

## 页面组件开发规则

### 1. 页面组件结构
```typescript
interface PageProps {
  params: Promise<{ locale: string }>
}

export default async function PageComponent({ params }: PageProps) {
  const { locale } = await params
  
  // 启用静态渲染
  setRequestLocale(locale)
  
  // 获取翻译文本
  const t = await getTranslations('namespace')
  
  // 获取多语言数据
  const data = getI18nJsonData('filename.json', locale)
  
  return (
    // JSX content using t() for translations
  )
}
```

### 2. 必须导入
```typescript
import { setRequestLocale } from 'next-intl/server'
import { getTranslations } from 'next-intl/server'
import { getI18nJsonData, getI18nArticle, getI18nSiteData } from '@/lib/i18n-data'
```

### 3. 静态生成支持
在布局组件中添加：
```typescript
export function generateStaticParams() {
  return routing.locales.map((locale) => ({ locale }));
}
```

## 客户端组件规则

### 1. 客户端组件结构
```typescript
'use client'

import { useTranslations, useLocale } from 'next-intl'
import { useRouter, usePathname, Link } from '@/i18n/navigation'

export default function ClientComponent({ locale }: { locale?: string }) {
  const t = useTranslations('namespace')
  const currentLocale = useLocale()
  
  return (
    // JSX content using t() for translations
  )
}
```

### 2. 导航组件
- 使用 `@/i18n/navigation` 而不是 `next/link` 或 `next/navigation`
- 所有 Link、useRouter、usePathname 都要从国际化包装器导入

### 3. 语言切换
```typescript
const router = useRouter()
const pathname = usePathname()

const switchLanguage = (newLocale: string) => {
  router.replace(pathname, { locale: newLocale })
}
```

## 翻译文件规则

### 1. 文件位置
```
messages/
├── zh.json          # 中文翻译
└── en.json          # 英文翻译
```

### 2. 命名空间结构
```json
{
  "navigation": {
    "home": "首页",
    "site": "分类",
    "articles": "文章"
  },
  "common": {
    "loading": "加载中...",
    "error": "错误",
    "back": "返回"
  },
  "pages": {
    "home": {
      "title": "FindMyUsers",
      "subtitle": "副标题"
    }
  }
}
```

### 3. 嵌套访问
```typescript
const t = useTranslations('pages.home')
const title = t('title')  // 访问 pages.home.title
```

## API 路由规则

### 1. API 路由不需要国际化
API 路由保持在 `src/app/api/` 目录，不移动到 `[locale]` 下。

### 2. 数据获取 API
如果 API 需要返回多语言数据，应该：
```typescript
// API 路由中接受 locale 参数
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const locale = searchParams.get('locale') || 'zh'
  
  const data = getI18nJsonData('filename.json', locale)
  return NextResponse.json(data)
}
```

## 元数据和 SEO

### 1. 多语言元数据
```typescript
export async function generateMetadata({
  params
}: {
  params: Promise<{ locale: string }>;
}): Promise<Metadata> {
  const { locale } = await params;
  
  return {
    title: locale === 'zh' ? '中文标题' : 'English Title',
    description: locale === 'zh' ? '中文描述' : 'English Description',
    other: {
      'og:locale': locale === 'zh' ? 'zh_CN' : 'en_US',
    }
  };
}
```

### 2. hreflang 标签
next-intl 自动生成 hreflang 标签，确保 SEO 友好。

## 开发最佳实践

### 1. 组件 Props 设计
```typescript
interface ComponentProps {
  locale?: string  // 可选的 locale 参数
  // 其他 props
}

// 默认值设置
export default function Component({ locale = 'zh', ...props }: ComponentProps) {
  // 组件实现
}
```

### 2. 数据获取模式
```typescript
// 服务端组件 - 使用 async/await
const data = getI18nJsonData('filename.json', locale)

// 客户端组件 - 通过 props 传递或 API 调用
const { data } = useSWR(`/api/data?locale=${locale}`, fetcher)
```

### 3. 错误处理
```typescript
try {
  const data = getI18nJsonData('filename.json', locale)
  return data
} catch (error) {
  console.error(`Error loading data for locale ${locale}:`, error)
  // Fallback 到默认数据或显示错误状态
  return defaultData
}
```

## 部署和构建

### 1. 静态生成
所有页面支持静态生成，通过 `generateStaticParams` 预生成所有 locale 版本。

### 2. 构建优化
- 翻译文件在构建时自动优化
- 只包含使用的翻译字符串
- 支持代码分割

## 故障排查

### 常见问题

1. **翻译文本不显示**
   - 检查翻译 key 是否存在于对应的语言文件中
   - 确认使用正确的命名空间

2. **路由跳转错误**
   - 确保使用 `@/i18n/navigation` 中的导航组件
   - 检查 locale 参数是否正确传递

3. **数据 fallback 不工作**
   - 确认使用 `src/lib/i18n-data.ts` 中的函数
   - 检查文件路径是否正确

4. **静态生成失败**
   - 确保在布局和页面中正确调用 `setRequestLocale(locale)`
   - 检查 `generateStaticParams` 函数是否正确实现

## 新组件开发检查清单

### 页面组件
- [ ] 接受 `params: Promise<{ locale: string }>` 参数
- [ ] 调用 `setRequestLocale(locale)`
- [ ] 使用 `getTranslations()` 获取翻译
- [ ] 使用 i18n 数据获取函数
- [ ] 实现 `generateMetadata` (如果需要)

### 客户端组件
- [ ] 使用 `'use client'` 指令
- [ ] 从 `next-intl` 导入 hooks
- [ ] 从 `@/i18n/navigation` 导入导航组件
- [ ] 接受可选的 `locale` prop

### 数据处理
- [ ] 使用 `getI18nJsonData`, `getI18nArticle`, `getI18nSiteData`
- [ ] 实现 fallback 到中文版本
- [ ] 添加错误处理

### 翻译文件
- [ ] 在 `messages/zh.json` 和 `messages/en.json` 中添加翻译
- [ ] 使用合理的命名空间结构
- [ ] 确保所有必要的翻译 key 都存在

## 更新记录

- **2025-01-28**: 初始版本创建
- 包含完整的 i18n 实现规则和最佳实践
- 支持中英双语和 fallback 机制
- 涵盖页面、组件、数据、API 的国际化规则

- **2025-01-31**: 文章数据结构优化
- 修复 articles.json 与实际文章文件的路径不匹配问题
- 更新 articles.json 使用 slug 字段而非 path 字段
- 实现基于 articles.json 的文章列表管理

- **2025-01-31**: 字段文件架构重构
- 将分离的 `data/json/zh/site-fields.json` 和 `data/json/en/site-fields.json` 合并为统一的 `data/json/site-fields.json`
- 采用嵌套对象结构，每个字段包含 `zh` 和 `en` 子对象
- 更新 API 路由 `/api/fields/route.ts` 和工具函数 `field-utils.ts` 以支持新的统一格式
- 新增 `transformUnifiedToLocaleFormat` 函数用于数据格式转换
- 降低维护成本，提高数据一致性，保持向后兼容性

- **2025-01-31**: People Messages 文件架构重构
- 将分离的 `data/json/zh/people-messages.json` 和 `data/json/en/people-messages.json` 合并为统一的 `data/json/people-messages.json`
- 采用嵌套对象结构：`{ "messages": { "zh": [...], "en": [...] } }`
- 更新 `PeopleIllustration.tsx` 组件以支持新的统一格式
- 简化导入逻辑，从两个文件导入改为单一文件导入
- 实现语言回退机制，当指定语言不存在时回退到中文版本